package com.webank.wecross.stub.bcos3.contract;

import static junit.framework.TestCase.assertTrue;

import com.webank.wecross.stub.ObjectMapperFactory;
import java.io.IOException;
import org.fisco.bcos.sdk.v3.client.protocol.model.JsonTransactionResponse;
import org.fisco.bcos.sdk.v3.client.protocol.response.BcosBlock;
import org.fisco.bcos.sdk.v3.crypto.CryptoSuite;
import org.fisco.bcos.sdk.v3.model.TransactionReceipt;
import org.fisco.bcos.sdk.v3.utils.MerkleProofUtility;
import org.junit.Before;
import org.junit.Test;

public class ProofVerifierUtilityTest {
    private String blockJson =
            "{\"consensusWeights\":[1,1,1,1],\"extraData\":\"0x\",\"gasUsed\":\"4166351\",\"hash\":\"0xf8bcb3fee47b4edc766018198883c83bbc20932d86465bc361b56b41f7e66f1c\",\"number\":60,\"parentInfo\":[{\"blockHash\":\"0x45919df6aa448223d7cc6f0296eb563308988d68917b18e259db93abd5274b3f\",\"blockNumber\":59}],\"receiptsRoot\":\"0x6490960e3ac57b325f2aef7dda6e30baec6e36f694d9b6612e0859aef781e440\",\"sealer\":3,\"sealerList\":[\"0x076fda2a4be28a80eb69a8c857d898f75be8ef4f52b18da1bb0adeeb51a71ee52b46e358a25cb28ae3561521973a710f9b5fca0234fa2a7829fbb2e3b29203ae\",\"0x09a6435dc5e10c98b1a064c43c5286ec93f5f7b5e9e888f610da447b80e9792e1a1f62421ef7b46bfccdff7a7832be3c6a4843cb1dd551ce09b1f237f3968bcb\",\"0x104b992b4d5e13ccd9b84f6639eb02770bb190cd2703d212c034381520c37f390f3feeb257a9567c98999c57ad9e0fb57518f27d5f4577baed56488a8f7d67ba\",\"0xc8c5a966973483b00d29e597ffd661d96f85cc5893aa4347ca9ae7f59106880b4249e34ccd89e3cd46d1ad11e3f7d27bc04ed8737e85f225c1ec314470177c3e\"],\"signatureList\":[{\"sealerIndex\":0,\"signature\":\"0x60964bad6e6a36542b869f18b59cef93ccf178000be89fdc29e1c6514a869a893d9ec190d38adcd3438134d8e26914148d8c0c7690d9b969df1ed55b4392ab1200\"},{\"sealerIndex\":1,\"signature\":\"0x44ddf02aea954001ecf33b5570cdbf87db5c1345fe665f6d92604e3b94cda92611f3510f3e2e080d6758573a3e3584ca65a7b900957fae7735afab28978f88b501\"},{\"sealerIndex\":2,\"signature\":\"0x0baac24b2cec82a99f5034cffdbf88d093495168851e85703fdcf9cb58de0d702bac213ff31101b8fddd5c8c13e0e830c53786aa37fb5f472eb7ca55fd08666b01\"},{\"sealerIndex\":3,\"signature\":\"0x15f55b4b821a64b3587cfcbe20dcc316ceb87c86c2872fdd15f020aaf724170e6a9ab29cfcaed552ec4f47469421ba0c7af0da816e40a42740252c7b9c72a38e01\"}],\"stateRoot\":\"0xe683134161f330ef914da606488ba8980b5d3c3fe8249690c830dd66d1eb9cbc\",\"timestamp\":1671072355746,\"txsRoot\":\"0x8d1989a6bb1a1b06bbfc374a0313f730a1d9d15cfa100f2848129db43668159a\",\"version\":50462720}";
    private String transactionAndProofJson =
            "{\"abi\":\"\",\"blockLimit\":554,\"chainID\":\"chain0\",\"from\":\"0x140f20415de989389679f3a81c2b1d06f2f82798\",\"groupID\":\"group0\",\"hash\":\"0xf98d0f89b6e9168ae06774fe8c47ec1f52089981f3be1defe42224390a9f5575\",\"importTime\":1671072355756,\"input\":\"0x8a42ebe90000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000000000000000000000000000000000c3633396138613566313738320000000000000000000000000000000000000000\",\"nonce\":\"4136701130988509121948934947898764904775782030652789273072312359979157486885\",\"signature\":\"0x469080546cd3ebc755cac094bc9b0ad77823aeaa4bf4c26235d81f20819f5e0733789c9e2efffc609780c7e296aa3dff312656b9eccb53244f9d7747675124b401\",\"to\":\"0x2f4de204ede2876817dadc543f264c6b237b0110\",\"txProof\":[\"0000000200000000000000000000000000000000000000000000000000000000\",\"4de1454f8cf61dc10dbf46cbe98a24585aa08d620e08edd1f64d83ef52b52e3b\",\"f98d0f89b6e9168ae06774fe8c47ec1f52089981f3be1defe42224390a9f5575\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"c2fa8f92cd1ad5047e9e2f177ed301e8c369270fea1be40a686ddc78f1f62114\",\"a320b77309176a0ac283faf2b6fbf4bbc351b0c8d43ba08cff5d4709bc63883d\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"68c19a01b502e7c920c71d98657421f488809b40adf60a9bb55cb3e01b615b98\",\"10a9c430464d77f45c2356d15688663b73b1301cc2af68af7a99216d1558be7d\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f3b87a0bb438eb54af429944c9e63f61ed95e269916a0501bb6c760e0f19f2f9\",\"8ea8a7a454a3d3918e446cd4ede65193ff5539f031cb976d438c37b33276ce37\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"710732a888d3c72a1423e241c1cb1f43b7e993e478983bc5761af21945c02407\",\"23da037299ca5baba2e095534558017fe6e1154f812f83ae2bd2584b5a1cb1fb\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f1a6b9aefe20d3b5bbadf77c0e5073c0aca30689a799b595c651eb3a22b0c684\",\"6b275e623abd8499a8ba8a98bf774ac66b52bea00d0a1925a6647d1c1e598081\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"693b2c27e57099b9551cd06700c4aa62b0da6f333f716df6151e04668d8f209c\",\"b76067e9f0d592239fec678a1a84502cb29f38c1c85a64dc16535a29ee90c710\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"c130e08435412b02b6468346e2b501a4d8d5fc762522bd1675aa106f0ef88673\",\"54a7731a61f48b6e24a21fb4499b1a667a866b0e4170b7805d76fd456a7b1fe6\",\"0000000100000000000000000000000000000000000000000000000000000000\",\"b30627b6162135e5c247aba6e418d654a99b600522bad461967c0499b617c9b5\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f782d49308f08310d7a9e70ee188600aa8ad2ef5716e228e701df9735a8de08b\",\"3b8d5d336f0e322ee54f1a2972a034a5b4a205d787cc8e53657e403c16f34959\"],\"version\":0}";
    private String transactionReceiptAndProofJson =
            "{\"blockNumber\":60,\"checksumContractAddress\":\"\",\"contractAddress\":\"\",\"from\":\"0x140f20415de989389679f3a81c2b1d06f2f82798\",\"gasUsed\":\"5893\",\"hash\":\"0xa8cb83fd3827e1a289a0be091ea4c96685ca74d3f4beeb0125d6bdc3ee150e82\",\"input\":\"0x8a42ebe90000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000003b9aca00000000000000000000000000000000000000000000000000000000000000000c3633396138613566313738320000000000000000000000000000000000000000\",\"logEntries\":[],\"message\":\"\",\"output\":\"0x\",\"txReceiptProof\":[\"0000000200000000000000000000000000000000000000000000000000000000\",\"a8cb83fd3827e1a289a0be091ea4c96685ca74d3f4beeb0125d6bdc3ee150e82\",\"a8cb83fd3827e1a289a0be091ea4c96685ca74d3f4beeb0125d6bdc3ee150e82\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"46fe5eeb4bbd202abc30c6851ba5769a00827dd7be9a693dcc3f2438c1613de6\",\"46fe5eeb4bbd202abc30c6851ba5769a00827dd7be9a693dcc3f2438c1613de6\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f884e9e302408a3686a922beefa8032f5512d2aef28ea348d45452bdbfac29be\",\"f884e9e302408a3686a922beefa8032f5512d2aef28ea348d45452bdbfac29be\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"2a7ff6b43218dae223ab5f60e52bd4dbc75b677e74c7effac88dbc98d11291f8\",\"2a7ff6b43218dae223ab5f60e52bd4dbc75b677e74c7effac88dbc98d11291f8\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"903cf8e90352c975ef7fcba173fbcbe72130ccdd44450836aa5eee692c1626a9\",\"903cf8e90352c975ef7fcba173fbcbe72130ccdd44450836aa5eee692c1626a9\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"2e0c755fe985da0c5fa5c62c310018deb162f65b26558423769de452ba694e02\",\"2e0c755fe985da0c5fa5c62c310018deb162f65b26558423769de452ba694e02\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"91bc8cf3e169dc1bc466244f4a08560946b5f12a800c00e7f69cb5e26282a577\",\"91bc8cf3e169dc1bc466244f4a08560946b5f12a800c00e7f69cb5e26282a577\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"334170ef9c69480449ebb03d39cf5740c748abfe1bfb482b5269d3241e4c77a4\",\"334170ef9c69480449ebb03d39cf5740c748abfe1bfb482b5269d3241e4c77a4\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"5657ded82faf9225698869e96ffeb9c2fa30edc05793cca1ea2b84887540b274\",\"5657ded82faf9225698869e96ffeb9c2fa30edc05793cca1ea2b84887540b274\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"cebeb9e3cb878cb3be116c96433dbf59d905cb599fd60edc3b966a3c5bb3d845\",\"baac97ecd0e31e31b5d7faf7714fdecd2d8c7219ff2bd09008f9e75dbbfaf18d\"],\"status\":0,\"to\":\"0x2f4de204ede2876817dadc543f264c6b237b0110\",\"transactionHash\":\"0xf98d0f89b6e9168ae06774fe8c47ec1f52089981f3be1defe42224390a9f5575\",\"txProof\":[\"0000000200000000000000000000000000000000000000000000000000000000\",\"4de1454f8cf61dc10dbf46cbe98a24585aa08d620e08edd1f64d83ef52b52e3b\",\"f98d0f89b6e9168ae06774fe8c47ec1f52089981f3be1defe42224390a9f5575\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"c2fa8f92cd1ad5047e9e2f177ed301e8c369270fea1be40a686ddc78f1f62114\",\"a320b77309176a0ac283faf2b6fbf4bbc351b0c8d43ba08cff5d4709bc63883d\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"68c19a01b502e7c920c71d98657421f488809b40adf60a9bb55cb3e01b615b98\",\"10a9c430464d77f45c2356d15688663b73b1301cc2af68af7a99216d1558be7d\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f3b87a0bb438eb54af429944c9e63f61ed95e269916a0501bb6c760e0f19f2f9\",\"8ea8a7a454a3d3918e446cd4ede65193ff5539f031cb976d438c37b33276ce37\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"710732a888d3c72a1423e241c1cb1f43b7e993e478983bc5761af21945c02407\",\"23da037299ca5baba2e095534558017fe6e1154f812f83ae2bd2584b5a1cb1fb\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f1a6b9aefe20d3b5bbadf77c0e5073c0aca30689a799b595c651eb3a22b0c684\",\"6b275e623abd8499a8ba8a98bf774ac66b52bea00d0a1925a6647d1c1e598081\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"693b2c27e57099b9551cd06700c4aa62b0da6f333f716df6151e04668d8f209c\",\"b76067e9f0d592239fec678a1a84502cb29f38c1c85a64dc16535a29ee90c710\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"c130e08435412b02b6468346e2b501a4d8d5fc762522bd1675aa106f0ef88673\",\"54a7731a61f48b6e24a21fb4499b1a667a866b0e4170b7805d76fd456a7b1fe6\",\"0000000100000000000000000000000000000000000000000000000000000000\",\"b30627b6162135e5c247aba6e418d654a99b600522bad461967c0499b617c9b5\",\"0000000200000000000000000000000000000000000000000000000000000000\",\"f782d49308f08310d7a9e70ee188600aa8ad2ef5716e228e701df9735a8de08b\",\"3b8d5d336f0e322ee54f1a2972a034a5b4a205d787cc8e53657e403c16f34959\"],\"version\":0}";

    private String blockJson0 =
            "{\"consensusWeights\":[1,1,1,1],\"extraData\":\"0x\",\"gasUsed\":\"13088\",\"hash\":\"0xb51bf83bca8062a2a5b62148060b3c2445bdeca424c91aa3e56a3a79b6cc8383\",\"number\":72,\"parentInfo\":[{\"blockHash\":\"0x3c1c9d24d730ef2180525c6606bc2e934e618df9f02ab3c85abdc0db55da33cb\",\"blockNumber\":71}],\"receiptsRoot\":\"0x759d4feef082f5e0088baae80f82104aac10639999692c934a78980759d58e47\",\"sealer\":3,\"sealerList\":[\"0x076fda2a4be28a80eb69a8c857d898f75be8ef4f52b18da1bb0adeeb51a71ee52b46e358a25cb28ae3561521973a710f9b5fca0234fa2a7829fbb2e3b29203ae\",\"0x09a6435dc5e10c98b1a064c43c5286ec93f5f7b5e9e888f610da447b80e9792e1a1f62421ef7b46bfccdff7a7832be3c6a4843cb1dd551ce09b1f237f3968bcb\",\"0x104b992b4d5e13ccd9b84f6639eb02770bb190cd2703d212c034381520c37f390f3feeb257a9567c98999c57ad9e0fb57518f27d5f4577baed56488a8f7d67ba\",\"0xc8c5a966973483b00d29e597ffd661d96f85cc5893aa4347ca9ae7f59106880b4249e34ccd89e3cd46d1ad11e3f7d27bc04ed8737e85f225c1ec314470177c3e\"],\"signatureList\":[{\"sealerIndex\":0,\"signature\":\"0x3233a2da4367ccbbc2f4b1f032f04254976fdc73416bfc8ab7490541884b961d62d9a5c8b63a259416b979b15dc34fe726e16c6eb60572461f31b08c8d9410de01\"},{\"sealerIndex\":1,\"signature\":\"0x62ff53b6b1fbabb323fc44d2d9001853a4d6c1e8b97c42aa9c6b46e6ea85dc0c6ce65fa16153661e07e818dcb2eed254d61251b0ddebfcabb0dfd27410b0de8901\"},{\"sealerIndex\":3,\"signature\":\"0x6d6bcbc067d85157a449fc72694fecd4640e2ae5a7cc6433170d18ea6f7cdc8b3a523547a29410caabb125e37fde6cda3bbae9941d02527a7ed466236fb51eb700\"}],\"stateRoot\":\"0x6c758f9387a7d692812f221d83f817b4bb953913cd68b29be6c756f991deab87\",\"timestamp\":1671086632842,\"transactions\":[\"0xa7c9868b5780c4ab9ee8e7713b132e5b8b1b3de65060dc2aaa18aba1fb8da6c1\"],\"txsRoot\":\"0xa7c9868b5780c4ab9ee8e7713b132e5b8b1b3de65060dc2aaa18aba1fb8da6c1\",\"version\":50462720}";
    private String transactionAndProofJson0 =
            "{\"abi\":\"\",\"blockLimit\":571,\"chainID\":\"chain0\",\"from\":\"0xc3905204c48f8bdffe5e57c465d178d4648416a4\",\"groupID\":\"group0\",\"hash\":\"0xa7c9868b5780c4ab9ee8e7713b132e5b8b1b3de65060dc2aaa18aba1fb8da6c1\",\"importTime\":1671086632867,\"input\":\"0x4ed3885e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000036161610000000000000000000000000000000000000000000000000000000000\",\"nonce\":\"21057836295043339615578907092452971954661623224251924593750627344535423728157\",\"signature\":\"0x8c0ba4ee926b6ab239bd6d37420c48fe11b1a44189ae745be7e7d60fb78b89bf0f0a608209c492d5035cbd928d71c5b37d33faad61d7c14e3247447d364820a001\",\"to\":\"0xbf5dabac8a87e5d1f8da357e119c0f19f8c40b91\",\"version\":0}";
    private String transactionReceiptAndProofJson0 =
            "{\"blockNumber\":72,\"checksumContractAddress\":\"\",\"contractAddress\":\"\",\"from\":\"0xc3905204c48f8bdffe5e57c465d178d4648416a4\",\"gasUsed\":\"13088\",\"hash\":\"0x759d4feef082f5e0088baae80f82104aac10639999692c934a78980759d58e47\",\"input\":\"0x4ed3885e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000036161610000000000000000000000000000000000000000000000000000000000\",\"logEntries\":[],\"message\":\"\",\"output\":\"0x\",\"status\":0,\"to\":\"0xbf5dabac8a87e5d1f8da357e119c0f19f8c40b91\",\"transactionHash\":\"0xa7c9868b5780c4ab9ee8e7713b132e5b8b1b3de65060dc2aaa18aba1fb8da6c1\",\"transactionProof\":null,\"version\":0}";

    private BcosBlock.Block block = null;
    private TransactionReceipt receipt = null;
    private JsonTransactionResponse transAndProof = null;
    private TransactionReceipt receiptAndProof = null;

    private BcosBlock.Block block0 = null;
    private TransactionReceipt receipt0 = null;
    private JsonTransactionResponse transAndProof0 = null;
    private TransactionReceipt receiptAndProof0 = null;
    private CryptoSuite cryptoSuite = new CryptoSuite(0);

    @Before
    public void init() throws IOException {
        block = ObjectMapperFactory.getObjectMapper().readValue(blockJson, BcosBlock.Block.class);
        transAndProof =
                ObjectMapperFactory.getObjectMapper()
                        .readValue(transactionAndProofJson, JsonTransactionResponse.class);
        receiptAndProof =
                ObjectMapperFactory.getObjectMapper()
                        .readValue(transactionReceiptAndProofJson, TransactionReceipt.class);

        block0 = ObjectMapperFactory.getObjectMapper().readValue(blockJson0, BcosBlock.Block.class);
        transAndProof0 =
                ObjectMapperFactory.getObjectMapper()
                        .readValue(transactionAndProofJson0, JsonTransactionResponse.class);
        receiptAndProof0 =
                ObjectMapperFactory.getObjectMapper()
                        .readValue(transactionReceiptAndProofJson0, TransactionReceipt.class);
    }

    @Test
    public void verifyTransactionTest() {

        assertTrue(
                MerkleProofUtility.verifyMerkle(
                        block.getTransactionsRoot(),
                        transAndProof.getTxProof(),
                        transAndProof.getHash(),
                        cryptoSuite));
        assertTrue(
                MerkleProofUtility.verifyMerkle(
                        block0.getTransactionsRoot(),
                        transAndProof0.getTxProof(),
                        transAndProof0.getHash(),
                        cryptoSuite));
    }

    @Test
    public void verifyTransactionReceiptTest() {
        assertTrue(
                MerkleProofUtility.verifyMerkle(
                        block.getReceiptsRoot(),
                        receiptAndProof.getTxReceiptProof(),
                        receiptAndProof.getReceiptHash(),
                        cryptoSuite));
        assertTrue(
                MerkleProofUtility.verifyMerkle(
                        block0.getReceiptsRoot(),
                        receiptAndProof0.getTxReceiptProof(),
                        receiptAndProof0.getReceiptHash(),
                        cryptoSuite));
    }
}
